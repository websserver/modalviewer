<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visualizador 3D AR</title>
    
    <!-- Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Visualizador 3D em AR</h1>
        
        <!-- Mensagem de erro -->
        <div id="error-message" class="error-message" style="display: none;">
            <p>Ocorreu um erro ao carregar o modelo. Por favor, tente novamente.</p>
        </div>
        
        <!-- Botão AR Personalizado para iOS -->
        <button id="ar-button-ios" class="ar-button" style="display: none;">
            Abrir em AR (iOS)
        </button>
        
        <model-viewer
            src="modelo3d/modelo.glb"
            ios-src="modelo3d/modelo.usdz#allowsContentScaling=1"
            alt="Modelo 3D"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            auto-rotate
            shadow-intensity="1"
            shadow-softness="1"
            exposure="1"
            interaction-prompt="none"
            ar-placement="floor"
            ar-scale="fixed"
            loading="eager"
            style="width: 100%; height: 70vh; background-color: #ffffff;">

            <button slot="ar-button" id="ar-button" class="ar-button">
                Ver em AR
            </button>

            <div class="progress-bar hide" slot="progress-bar">
                <div class="update-bar"></div>
            </div>

            <!-- Dicas de uso -->
            <div class="ar-prompt">
                <p id="ar-prompt-text">Carregando modelo...</p>
            </div>
        </model-viewer>

        <div class="controls">
            <button id="rotate-left">⟲ Girar Esquerda</button>
            <button id="rotate-right">⟳ Girar Direita</button>
            <button id="zoom-in">+ Aproximar</button>
            <button id="zoom-out">- Afastar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modelViewer = document.querySelector('model-viewer');
            const arButton = document.getElementById('ar-button');
            const arButtonIOS = document.getElementById('ar-button-ios');
            const errorMessage = document.getElementById('error-message');
            const arPromptText = document.getElementById('ar-prompt-text');
            
            // Detectar iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                // Configurar botão AR para iOS
                arButtonIOS.style.display = 'block';
                arPromptText.textContent = 'Toque no botão azul para iniciar AR no iOS';
                
                arButtonIOS.addEventListener('click', function() {
                    try {
                        const anchor = document.createElement('a');
                        anchor.setAttribute('rel', 'ar');
                        anchor.appendChild(document.createElement('img'));
                        anchor.setAttribute('href', 'modelo3d/modelo.usdz#allowsContentScaling=1');
                        
                        // Adicionar parâmetros para melhor compatibilidade
                        const params = new URLSearchParams({
                            allowsContentScaling: '1',
                            canonicalWebPageURL: window.location.href
                        });
                        
                        anchor.href = `${anchor.href}?${params.toString()}`;
                        anchor.click();
                    } catch (error) {
                        console.error('Erro ao abrir AR no iOS:', error);
                        errorMessage.style.display = 'block';
                        errorMessage.querySelector('p').textContent = 
                            'Erro ao abrir AR no iOS. Certifique-se de estar usando Safari.';
                    }
                });
            } else {
                arPromptText.textContent = 'Toque no botão verde para iniciar AR';
            }

            // Verificar suporte a AR
            if (modelViewer) {
                modelViewer.addEventListener('ar-status', (event) => {
                    if (event.detail.status === 'failed') {
                        console.error('Falha ao iniciar AR:', event.detail.error);
                        errorMessage.style.display = 'block';
                        errorMessage.querySelector('p').textContent = 
                            'Não foi possível iniciar o AR. Verifique se seu dispositivo suporta AR.';
                    }
                });

                modelViewer.addEventListener('load', () => {
                    console.log('Modelo carregado com sucesso');
                    arPromptText.textContent = isIOS ? 
                        'Toque no botão azul para iniciar AR no iOS' : 
                        'Toque no botão verde para iniciar AR';
                });

                modelViewer.addEventListener('error', (error) => {
                    console.error('Erro ao carregar modelo:', error);
                    errorMessage.style.display = 'block';
                    if (isIOS) {
                        errorMessage.querySelector('p').textContent = 
                            'Erro ao carregar o modelo 3D. Verifique sua conexão e tente novamente.';
                    }
                });
            }
        });
    </script>
</body>
</html> 